{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Pair a New Device - SecureApprove" %}{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        min-height: 100vh;
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, #eef2ff 0%, var(--bg-color) 50%, #faf5ff 100%);
    }
    [data-theme="dark"] .hero-section {
        background: linear-gradient(135deg, #1e1b4b 0%, var(--bg-color) 50%, #4c1d95 100%);
    }
    .pairing-card {
        max-width: 520px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 12px 30px var(--card-shadow);
        border: 1px solid var(--border-color);
    }
    .pairing-header-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }
    .pairing-step {
        display: none;
    }
    .pairing-step.active {
        display: block;
    }
    
    /* Custom notification popup */
    .pairing-notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .pairing-notification-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .pairing-notification {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        max-width: 420px;
        width: 90%;
        padding: 1.5rem;
        transform: scale(0.9) translateY(-20px);
        transition: transform 0.3s ease;
    }
    .pairing-notification-overlay.show .pairing-notification {
        transform: scale(1) translateY(0);
    }
    .pairing-notification-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }
    .pairing-notification-icon.error {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #dc2626;
    }
    .pairing-notification-icon.warning {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #d97706;
    }
    .pairing-notification-icon.info {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #2563eb;
    }
    .pairing-notification-icon.success {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #059669;
    }
    [data-theme="dark"] .pairing-notification-icon.error {
        background: linear-gradient(135deg, #7f1d1d, #991b1b);
        color: #fca5a5;
    }
    [data-theme="dark"] .pairing-notification-icon.warning {
        background: linear-gradient(135deg, #78350f, #92400e);
        color: #fcd34d;
    }
    [data-theme="dark"] .pairing-notification-icon.info {
        background: linear-gradient(135deg, #1e3a8a, #1e40af);
        color: #93c5fd;
    }
    [data-theme="dark"] .pairing-notification-icon.success {
        background: linear-gradient(135deg, #064e3b, #065f46);
        color: #6ee7b7;
    }
    .pairing-notification-title {
        font-weight: 600;
        font-size: 1.1rem;
        text-align: center;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }
    .pairing-notification-message {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1.25rem;
    }
    .pairing-notification-btn {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .pairing-notification-btn-primary {
        background: var(--primary-color);
        color: white;
        border: none;
    }
    .pairing-notification-btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<!-- Custom Notification Popup -->
<div id="pairingNotificationOverlay" class="pairing-notification-overlay">
    <div class="pairing-notification">
        <div id="pairingNotificationIcon" class="pairing-notification-icon error">
            <i id="pairingNotificationIconI" class="bi bi-exclamation-triangle-fill" style="font-size: 24px;"></i>
        </div>
        <div id="pairingNotificationTitle" class="pairing-notification-title">{% trans "Error" %}</div>
        <div id="pairingNotificationMessage" class="pairing-notification-message"></div>
        <button type="button" id="pairingNotificationBtn" class="pairing-notification-btn pairing-notification-btn-primary">
            {% trans "OK" %}
        </button>
    </div>
</div>

<section class="hero-section">
    <div class="container">
        <div class="pairing-card p-4">
            {% if invalid %}
                <div class="text-center">
                    <div class="pairing-header-icon mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-white" style="font-size: 28px;"></i>
                    </div>
                    <h3 class="fw-bold mb-2">{% trans "Pairing Link Invalid or Expired" %}</h3>
                    <p class="text-muted">
                        {% trans "This device pairing link is no longer valid. Please generate a new link from your SecureApprove profile." %}
                    </p>
                </div>
            {% else %}
                <div class="text-center mb-3">
                    <div class="pairing-header-icon">
                        <i class="bi bi-phone-fill text-white" style="font-size: 28px;"></i>
                    </div>
                    <h3 class="fw-bold mb-1">{% trans "Pair This Device" %}</h3>
                    <p class="text-muted mb-0">
                        {% blocktrans with email=user_email %}
                        You are about to pair this device with the account {{ email }}.
                        {% endblocktrans %}
                    </p>
                </div>

                <div id="pairingSteps">
                    <div class="pairing-step active" id="pairStep1">
                        <h6 class="fw-semibold mb-2">{% trans "Prepare Your Biometric Sensor" %}</h6>
                        <p class="text-muted small mb-3">
                            {% trans "When you continue, your browser will ask you to confirm with your fingerprint, Face ID, or security key." %}
                        </p>
                        <div class="alert alert-info alert-custom alert-info-custom mb-3">
                            <div class="d-flex">
                                <i class="bi bi-shield-lock text-primary me-2"></i>
                                <small class="text-muted">
                                    {% trans "This device will be added as an additional authenticator for your existing SecureApprove account." %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="pairing-step" id="pairStep2">
                        <h6 class="fw-semibold mb-2">{% trans "Touch Your Sensor" %}</h6>
                        <p class="text-muted small mb-3">
                            {% trans "Use your fingerprint, Face ID, or security key on this device to complete the pairing." %}
                        </p>
                    </div>

                    <div class="pairing-step" id="pairStep3">
                        <h6 class="fw-semibold text-success mb-2">{% trans "Device Paired Successfully!" %}</h6>
                        <p class="text-muted small mb-3">
                            {% trans "You can now sign in to SecureApprove from this device using your biometric authentication." %}
                        </p>
                    </div>

                    <!-- Step for already paired device -->
                    <div class="pairing-step" id="pairStepAlreadyPaired">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 48px;"></i>
                            </div>
                            <h6 class="fw-semibold text-success mb-2">{% trans "This Device is Already Paired!" %}</h6>
                            <p class="text-muted small mb-3">
                                {% trans "Good news! You already have a passkey for this account on this device. You can sign in directly without needing to pair again." %}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3" id="pairingActions">
                    <a href="/" class="btn btn-outline-secondary">
                        {% trans "Cancel" %}
                    </a>
                    <button type="button" class="btn btn-primary" id="startPairingBtn">
                        {% trans "Pair This Device" %}
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</section>

{% if not invalid %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const startBtn = document.getElementById('startPairingBtn');
    const stepsContainer = document.getElementById('pairingSteps');
    const actionsContainer = document.getElementById('pairingActions');
    const token = '{{ pairing_token }}';
    
    // Notification popup elements
    const notificationOverlay = document.getElementById('pairingNotificationOverlay');
    const notificationIcon = document.getElementById('pairingNotificationIcon');
    const notificationIconI = document.getElementById('pairingNotificationIconI');
    const notificationTitle = document.getElementById('pairingNotificationTitle');
    const notificationMessage = document.getElementById('pairingNotificationMessage');
    const notificationBtn = document.getElementById('pairingNotificationBtn');
    
    // Notification type configurations
    const notificationTypes = {
        error: {
            icon: 'bi-exclamation-triangle-fill',
            title: "{% trans 'Error' %}",
            class: 'error'
        },
        warning: {
            icon: 'bi-exclamation-circle-fill',
            title: "{% trans 'Warning' %}",
            class: 'warning'
        },
        info: {
            icon: 'bi-info-circle-fill',
            title: "{% trans 'Information' %}",
            class: 'info'
        },
        success: {
            icon: 'bi-check-circle-fill',
            title: "{% trans 'Success' %}",
            class: 'success'
        }
    };
    
    function showNotification(message, type = 'error', onClose = null) {
        const config = notificationTypes[type] || notificationTypes.error;
        
        notificationIcon.className = 'pairing-notification-icon ' + config.class;
        notificationIconI.className = 'bi ' + config.icon;
        notificationTitle.textContent = config.title;
        notificationMessage.textContent = message;
        
        notificationOverlay.classList.add('show');
        
        // Handle close
        const closeHandler = function() {
            notificationOverlay.classList.remove('show');
            notificationBtn.removeEventListener('click', closeHandler);
            if (onClose) onClose();
        };
        
        notificationBtn.addEventListener('click', closeHandler);
        
        // Also close on overlay click
        notificationOverlay.addEventListener('click', function(e) {
            if (e.target === notificationOverlay) {
                closeHandler();
            }
        }, { once: true });
    }

    function showPairStep(stepNumber) {
        if (!stepsContainer) return;
        stepsContainer.querySelectorAll('.pairing-step').forEach(step => {
            step.classList.remove('active');
            step.style.display = 'none';
        });
        const current = document.getElementById(`pairStep${stepNumber}`);
        if (current) {
            current.classList.add('active');
            current.style.display = 'block';
        }
    }

    function base64urlToBuffer(base64url) {
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const padded = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');
        const binary = atob(padded);
        const buffer = new ArrayBuffer(binary.length);
        const view = new Uint8Array(buffer);
        for (let i = 0; i < binary.length; i++) {
            view[i] = binary.charCodeAt(i);
        }
        return buffer;
    }

    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        // Process in chunks to avoid stack overflow on iOS Safari
        const chunkSize = 8192;
        for (let i = 0; i < bytes.byteLength; i += chunkSize) {
            const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.byteLength));
            binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    function isAlreadyPairedError(error) {
        const name = (error && (error.name || error.code)) || '';
        const message = (error && error.message) || '';
        
        // InvalidStateError means credential already exists
        if (name === 'InvalidStateError') return true;
        
        // UnknownError with "credential manager" message often means duplicate
        if (name === 'UnknownError') return true;
        
        // Check for specific messages
        if (message && message.toLowerCase().indexOf('unknown error') !== -1) return true;
        if (message && message.toLowerCase().indexOf('already exists') !== -1) return true;
        if (message && message.toLowerCase().indexOf('credential manager') !== -1) return true;
        
        return false;
    }

    function showAlreadyPairedStep() {
        showPairStep('AlreadyPaired');
        if (actionsContainer) {
            actionsContainer.innerHTML = `
                <a href="/auth/login/" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right me-2"></i>
                    {% trans "Sign In Now" %}
                </a>
            `;
        }
    }

    function getFriendlyErrorMessage(error) {
        const name = (error && (error.name || error.code)) || '';
        const message = (error && error.message) || '';

        console.log('WebAuthn Error Details:', { name, message, error });

        // If the error comes from our server, show it directly
        if (message && !name) {
            return message;
        }

        switch (name) {
            case 'NotAllowedError':
                // User cancelled, timed out, or OS/browser rejected silently
                return "{% trans 'The biometric prompt was cancelled or timed out. Please try again and make sure to confirm with your fingerprint, Face ID, or security key.' %}";
            case 'SecurityError':
                return "{% trans 'A security error occurred while creating the credential. Please ensure you are accessing SecureApprove directly over HTTPS and not inside another application.' %}";
            case 'NotSupportedError':
                return "{% trans 'This browser or device does not fully support WebAuthn passkeys for this site. Please use a compatible browser (Chrome, Safari, Edge, or Firefox) with passkeys enabled.' %}";
            case 'InvalidStateError':
                return null; // We'll show the already paired step instead
            case 'UnknownError':
                return null; // We'll show the already paired step instead
            default:
                // Fallback if the browser returns a generic error
                if (message && message.indexOf('operation either timed out or was not allowed') !== -1) {
                    return "{% trans 'The operation either timed out or was not allowed by the browser. Please try again, and check your browser privacy settings.' %}";
                }
                if (message && message.toLowerCase().indexOf('unknown error') !== -1) {
                    return null; // We'll show the already paired step instead
                }
                // Show the actual error message if available
                if (message) {
                    return message;
                }
                return "{% trans 'An unexpected error occurred while adding this device. Please try again.' %}";
        }
    }

    if (startBtn) {
        startBtn.addEventListener('click', async function () {
            try {
                if (!navigator.credentials || !navigator.credentials.create) {
                    showNotification("{% trans 'WebAuthn is not supported in your browser. Please use Chrome, Firefox, Safari, or Edge.' %}", 'warning');
                    return;
                }

                showPairStep(2);
                startBtn.disabled = true;

                // Step 1: get options from server
                const optionsResponse = await fetch(`./begin/`, {
                    method: 'POST',
                    credentials: 'same-origin',  // Required for iOS Safari cookie handling
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const optionsResult = await optionsResponse.json();
                if (!optionsResult.success) {
                    throw new Error(optionsResult.error || 'Failed to get pairing options');
                }

                const publicKey = optionsResult.publicKey;
                // Decode challenge and user.id
                publicKey.challenge = base64urlToBuffer(publicKey.challenge);
                publicKey.user.id = base64urlToBuffer(publicKey.user.id);

                if (publicKey.excludeCredentials) {
                    publicKey.excludeCredentials = publicKey.excludeCredentials.map(cred => ({
                        ...cred,
                        id: base64urlToBuffer(cred.id)
                    }));
                }

                // Step 2: create credential on this device
                const credential = await navigator.credentials.create({ publicKey });
                if (!credential) {
                    throw new Error("{% trans 'WebAuthn registration was cancelled' %}");
                }

                // Step 3: send to server for verification
                const completeResponse = await fetch(`./complete/`, {
                    method: 'POST',
                    credentials: 'same-origin',  // Required for iOS Safari cookie handling
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        credential: {
                            id: credential.id,
                            rawId: bufferToBase64url(credential.rawId),
                            response: {
                                attestationObject: bufferToBase64url(credential.response.attestationObject),
                                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON)
                            },
                            type: credential.type
                        },
                        platform: navigator.userAgent || ''
                    })
                });

                const completeResult = await completeResponse.json();
                if (!completeResult.success) {
                    throw new Error(completeResult.error || 'Pairing failed');
                }

                showPairStep(3);
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <a href="/" class="btn btn-primary w-100">
                            {% trans "Go to Login" %}
                        </a>
                    `;
                }
            } catch (error) {
                console.error('Device pairing error:', error);
                
                // Check if this is an "already paired" type error
                if (isAlreadyPairedError(error)) {
                    showAlreadyPairedStep();
                    return;
                }
                
                const friendly = getFriendlyErrorMessage(error);
                if (friendly) {
                    showNotification(friendly, 'error', function() {
                        showPairStep(1);
                        if (startBtn) startBtn.disabled = false;
                    });
                } else {
                    showPairStep(1);
                    if (startBtn) startBtn.disabled = false;
                }
            }
        });
    }
});
</script>
{% endif %}

{% endblock %}
