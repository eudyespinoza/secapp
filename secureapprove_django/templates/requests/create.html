{% extends 'base.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "New Request" %} - SecureApprove{% endblock %}

{% block extra_css %}
<style>
    /* ===== Page Layout ===== */
    .create-request-page {
        min-height: calc(100vh - 120px);
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-color) 100%);
    }
    
    .page-header {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
    }
    
    .page-header .container-fluid {
        max-width: 1400px;
    }

    /* ===== Step Indicators ===== */
    .step-indicators {
        display: flex;
        justify-content: center;
        gap: 0;
        margin-bottom: 2rem;
        padding: 0 1rem;
    }
    
    .step-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .step-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: var(--font-sm);
        background: var(--bg-secondary);
        color: var(--text-muted);
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
    }
    
    .step-item.active .step-circle {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
    }
    
    .step-item.completed .step-circle {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }
    
    .step-label {
        font-size: var(--font-sm);
        color: var(--text-muted);
        font-weight: 500;
        display: none;
    }
    
    @media (min-width: 768px) {
        .step-label {
            display: block;
        }
    }
    
    .step-item.active .step-label {
        color: var(--primary-color);
    }
    
    .step-item.completed .step-label {
        color: var(--success-color);
    }
    
    .step-connector {
        width: 60px;
        height: 2px;
        background: var(--border-color);
        margin: 0 0.5rem;
    }
    
    .step-connector.completed {
        background: var(--success-color);
    }

    /* ===== Category Selection Cards ===== */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    @media (min-width: 768px) {
        .category-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (min-width: 992px) {
        .category-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
    
    .category-card {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .category-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }
    
    .category-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(79, 70, 229, 0.02) 100%);
    }
    
    .category-card.selected::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 32px 32px 0;
        border-color: transparent var(--primary-color) transparent transparent;
    }
    
    .category-card.selected::before {
        content: 'âœ“';
        position: absolute;
        top: 2px;
        right: 5px;
        color: white;
        font-size: 10px;
        font-weight: bold;
        z-index: 1;
    }
    
    .category-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        font-size: 1.25rem;
    }
    
    .category-card[data-category="expense"] .category-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .category-card[data-category="purchase"] .category-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .category-card[data-category="travel"] .category-icon { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
    .category-card[data-category="contract"] .category-icon { background: rgba(249, 115, 22, 0.1); color: #f97316; }
    .category-card[data-category="document"] .category-icon { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
    .category-card[data-category="other"] .category-icon { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
    
    .category-card.selected[data-category="expense"] { border-color: #10b981; }
    .category-card.selected[data-category="expense"]::after { border-color: transparent #10b981 transparent transparent; }
    .category-card.selected[data-category="purchase"] { border-color: #3b82f6; }
    .category-card.selected[data-category="purchase"]::after { border-color: transparent #3b82f6 transparent transparent; }
    .category-card.selected[data-category="travel"] { border-color: #a855f7; }
    .category-card.selected[data-category="travel"]::after { border-color: transparent #a855f7 transparent transparent; }
    .category-card.selected[data-category="contract"] { border-color: #f97316; }
    .category-card.selected[data-category="contract"]::after { border-color: transparent #f97316 transparent transparent; }
    .category-card.selected[data-category="document"] { border-color: #ec4899; }
    .category-card.selected[data-category="document"]::after { border-color: transparent #ec4899 transparent transparent; }
    .category-card.selected[data-category="other"] { border-color: #6b7280; }
    .category-card.selected[data-category="other"]::after { border-color: transparent #6b7280 transparent transparent; }
    
    .category-name {
        font-weight: 600;
        font-size: var(--font-sm);
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .category-hint {
        font-size: var(--font-xs);
        color: var(--text-muted);
        line-height: 1.3;
    }

    /* ===== Form Card ===== */
    .form-card {
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        overflow: hidden;
    }
    
    .form-card-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .form-card-header i {
        font-size: 1.25rem;
        opacity: 0.9;
    }
    
    .form-card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: var(--font-base);
    }
    
    .form-card-body {
        padding: 1.5rem;
    }

    /* ===== Form Controls ===== */
    .form-floating-custom {
        position: relative;
        margin-bottom: 1.25rem;
    }
    
    .form-floating-custom .form-control,
    .form-floating-custom .form-select {
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 10px;
        padding: 0.875rem 1rem;
        font-size: var(--font-sm);
        transition: all 0.2s ease;
        color: var(--text-color);
    }
    
    .form-floating-custom .form-control:focus,
    .form-floating-custom .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        background: var(--card-bg);
    }
    
    .form-floating-custom .form-label {
        font-size: var(--font-sm);
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-floating-custom .form-label .required {
        color: var(--danger-color);
    }
    
    .form-floating-custom .form-label i {
        color: var(--text-muted);
        font-size: var(--font-sm);
    }

    /* ===== Dynamic Groups ===== */
    .dynamic-group {
        transition: all 0.3s ease;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== Field Error ===== */
    .field-error {
        border-color: var(--danger-color) !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15) !important;
    }

    /* ===== Priority Badges ===== */
    .priority-selector {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }
    
    .priority-option {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--card-bg);
    }
    
    .priority-option:hover {
        border-color: var(--text-muted);
    }
    
    .priority-option.selected {
        border-width: 2px;
    }
    
    .priority-option.selected[data-priority="low"] {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
    }
    
    .priority-option.selected[data-priority="medium"] {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }
    
    .priority-option.selected[data-priority="high"] {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }
    
    .priority-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .priority-option[data-priority="low"] .priority-dot { background: #10b981; }
    .priority-option[data-priority="medium"] .priority-dot { background: #f59e0b; }
    .priority-option[data-priority="high"] .priority-dot { background: #ef4444; }

    /* ===== File Upload ===== */
    .file-upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background: var(--bg-secondary);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .file-upload-zone:hover,
    .file-upload-zone.dragover {
        border-color: var(--primary-color);
        background: rgba(79, 70, 229, 0.02);
    }
    
    .file-upload-zone i {
        font-size: 2.5rem;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }
    
    .file-list {
        margin-top: 1rem;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .file-item i {
        color: var(--primary-color);
    }
    
    .file-item .file-name {
        flex: 1;
        font-size: var(--font-sm);
        color: var(--text-color);
    }
    
    .file-item .file-size {
        font-size: var(--font-xs);
        color: var(--text-muted);
    }
    
    .file-item .remove-file {
        color: var(--danger-color);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .file-item .remove-file:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    /* ===== Preview Sidebar ===== */
    .preview-sidebar {
        position: sticky;
        top: 100px;
    }
    
    .preview-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .preview-header {
        background: var(--bg-secondary);
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .preview-header i {
        color: var(--primary-color);
    }
    
    .preview-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: var(--font-sm);
    }
    
    .preview-body {
        padding: 1.25rem;
    }
    
    .preview-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-muted);
    }
    
    .preview-empty i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }
    
    .preview-field {
        margin-bottom: 1rem;
    }
    
    .preview-field:last-child {
        margin-bottom: 0;
    }
    
    .preview-label {
        font-size: var(--font-xs);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    
    .preview-value {
        font-size: var(--font-sm);
        color: var(--text-color);
        font-weight: 500;
    }
    
    .preview-amount {
        font-size: var(--font-xl);
        font-weight: 700;
        color: var(--primary-color);
    }

    /* ===== Submit Button ===== */
    .submit-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    
    .btn-submit {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        border: none;
        color: white;
        padding: 0.875rem 2rem;
        font-size: var(--font-base);
        font-weight: 600;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.2s ease;
        box-shadow: 0 4px 14px rgba(79, 70, 229, 0.25);
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.35);
        color: white;
    }
    
    .btn-submit:active {
        transform: translateY(0);
    }
    
    .btn-submit i {
        font-size: 1.1rem;
    }

    /* ===== WebAuthn Modal Styles ===== */
    .webauthn-status {
        text-align: center;
        padding: 2rem;
    }
    
    .webauthn-status .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .webauthn-status .bi-fingerprint {
        font-size: 4rem;
        color: var(--primary-color);
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    .webauthn-success .bi-check-circle-fill {
        font-size: 4rem;
        color: var(--success-color);
    }
    
    .webauthn-error .bi-x-circle-fill {
        font-size: 4rem;
        color: var(--danger-color);
    }

    /* ===== Hide default crispy form elements ===== */
    #div_id_category,
    #div_id_priority,
    #div_id_attachments {
        display: none;
    }
    
    /* ===== Responsive Adjustments ===== */
    @media (max-width: 991px) {
        .preview-sidebar {
            position: static;
            margin-top: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1 fw-bold">{% trans "New Request" %}</h1>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">{% trans "Submit a new approval request for review" %}</p>
                </div>
                <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
                    <i class="bi bi-arrow-left"></i>
                    {% trans "Back to Requests" %}
                </a>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <!-- Main Form -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <form method="post" id="request-form" novalidate enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" id="webauthn_verified_token" name="webauthn_verified_token" value="">
                                {% crispy form %}
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Help Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2" style="font-size: var(--font-base);">
                                <i class="bi bi-info-circle text-primary"></i>
                                {% trans "Request Categories" %}
                            </h5>
                        </div>
                        <div class="card-body p-2">
                            <div class="category-help">
                                <div class="category-item mb-1" data-category="expense">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-receipt text-muted"></i>
                                        <strong style="font-size: var(--font-sm);">{% trans "Expense" %}</strong>
                                    </div>
                                    <p class="category-description mb-0">
                                        {% trans "Business expenses like meals, transportation, office supplies" %}
                                    </p>
                                </div>
                                
                                <div class="category-item mb-1" data-category="purchase">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-cart text-muted"></i>
                                        <strong style="font-size: var(--font-sm);">{% trans "Purchase" %}</strong>
                                    </div>
                                    <p class="category-description mb-0">
                                        {% trans "Equipment, software, or service purchases" %}
                                    </p>
                                </div>
                                
                                <div class="category-item mb-1" data-category="travel">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-airplane text-muted"></i>
                                        <strong style="font-size: var(--font-sm);">{% trans "Travel" %}</strong>
                                    </div>
                                    <p class="category-description mb-0">
                                        {% trans "Travel arrangements and related expenses" %}
                                    </p>
                                </div>
                                
                                <div class="category-item mb-1" data-category="contract">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-file-text text-muted"></i>
                                        <strong style="font-size: var(--font-sm);">{% trans "Contract" %}</strong>
                                    </div>
                                    <p class="category-description mb-0">
                                        {% trans "Contract approvals and vendor agreements" %}
                                    </p>
                                </div>
                                
                                <div class="category-item mb-1" data-category="document">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-file-earmark text-muted"></i>
                                        <strong style="font-size: var(--font-sm);">{% trans "Document" %}</strong>
                                    </div>
                                    <p class="category-description mb-0">
                                        {% trans "Document approvals and reviews" %}
                                    </p>
                                </div>
                                
                                <div class="category-item mb-0" data-category="other">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-three-dots text-muted"></i>
                                        <strong style="font-size: var(--font-sm);">{% trans "Other" %}</strong>
                                    </div>
                                    <p class="category-description mb-0">
                                        {% trans "Any other type of approval request" %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Card -->
                    <div class="card border-0 shadow-sm" id="preview-card" style="display: none;">
                        <div class="card-header">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2" style="font-size: var(--font-base);">
                                <i class="bi bi-eye text-primary"></i>
                                {% trans "Preview" %}
                            </h5>
                        </div>
                        <div class="card-body" id="preview-content">
                            <!-- Preview content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebAuthn Confirmation Modal -->
<div class="modal fade" id="webauthnModal" tabindex="-1" aria-labelledby="webauthnModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="webauthnModalLabel">
                    <i class="bi bi-shield-lock me-2"></i>
                    {% trans "Confirm Your Identity" %}
                </h5>
            </div>
            <div class="modal-body">
                <!-- Initial State -->
                <div id="webauthn-initial" class="webauthn-status">
                    <div class="mb-4">
                        <i class="bi bi-fingerprint"></i>
                    </div>
                    <h6 class="mb-2">{% trans "Biometric Verification Required" %}</h6>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Please authenticate using your fingerprint, face recognition, or security key to submit this request." %}
                    </p>
                </div>
                
                <!-- Processing State -->
                <div id="webauthn-processing" class="webauthn-status" style="display: none;">
                    <div class="mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{% trans "Loading..." %}</span>
                        </div>
                    </div>
                    <h6 class="mb-2">{% trans "Waiting for authentication..." %}</h6>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Please complete the biometric prompt on your device." %}
                    </p>
                </div>
                
                <!-- Success State -->
                <div id="webauthn-success" class="webauthn-status webauthn-success" style="display: none;">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h6 class="mb-2 text-success">{% trans "Authentication Successful" %}</h6>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Submitting your request..." %}
                    </p>
                </div>
                
                <!-- Error State -->
                <div id="webauthn-error" class="webauthn-status webauthn-error" style="display: none;">
                    <div class="mb-4">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <h6 class="mb-2 text-danger">{% trans "Authentication Failed" %}</h6>
                    <p class="text-muted mb-0" id="webauthn-error-message" style="font-size: var(--font-sm);">
                        {% trans "Please try again." %}
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" id="webauthn-cancel-btn" data-bs-dismiss="modal">
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" id="webauthn-confirm-btn">
                    <i class="bi bi-fingerprint me-2"></i>
                    {% trans "Authenticate" %}
                </button>
                <button type="button" class="btn btn-primary" id="webauthn-retry-btn" style="display: none;">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    {% trans "Try Again" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
                <i class="bi bi-info-circle me-2" id="toast-icon"></i>
                <span id="toast-message"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryField = document.getElementById('id_category');
    const amountField = document.getElementById('amount-field');
    const form = document.getElementById('request-form');
    const previewCard = document.getElementById('preview-card');
    const previewContent = document.getElementById('preview-content');
    const verifiedTokenField = document.getElementById('webauthn_verified_token');
    
    // WebAuthn Modal Elements
    const webauthnModal = new bootstrap.Modal(document.getElementById('webauthnModal'));
    const webauthnInitial = document.getElementById('webauthn-initial');
    const webauthnProcessing = document.getElementById('webauthn-processing');
    const webauthnSuccess = document.getElementById('webauthn-success');
    const webauthnError = document.getElementById('webauthn-error');
    const webauthnErrorMessage = document.getElementById('webauthn-error-message');
    const webauthnConfirmBtn = document.getElementById('webauthn-confirm-btn');
    const webauthnRetryBtn = document.getElementById('webauthn-retry-btn');
    const webauthnCancelBtn = document.getElementById('webauthn-cancel-btn');
    
    // Toast elements
    const toastEl = document.getElementById('notification-toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');
    
    // WebAuthn URLs
    const webauthnOptionsUrl = "{% url 'requests:create-webauthn-options' %}";
    const webauthnVerifyUrl = "{% url 'requests:create-webauthn-verify' %}";
    
    // Store form data for WebAuthn flow
    let pendingFormData = null;
    let creationToken = null;
    let isSubmittingAfterWebAuthn = false;  // Flag to bypass WebAuthn modal on verified submit
    
    // Category configurations (matches Django form)
    const categoryConfigs = {
        'expense': {
            'show_amount': true,
            'required_fields': ['title', 'description', 'amount', 'priority', 'expense_category', 'receipt_ref'],
            'extra_fields': ['expense_category', 'receipt_ref']
        },
        'purchase': {
            'show_amount': true,
            'required_fields': ['title', 'description', 'amount', 'priority', 'purchase_vendor', 'cost_center'],
            'extra_fields': ['purchase_vendor', 'cost_center']
        },
        'travel': {
            'show_amount': true,
            'required_fields': ['title', 'description', 'amount', 'priority', 'destination', 'start_date', 'end_date'],
            'extra_fields': ['destination', 'start_date', 'end_date']
        },
        'contract': {
            'show_amount': false,
            'required_fields': ['title', 'description', 'priority', 'contract_vendor', 'contract_reason'],
            'extra_fields': ['contract_vendor', 'contract_reason']
        },
        'document': {
            'show_amount': false,
            'required_fields': ['title', 'description', 'priority', 'document_id', 'document_reason'],
            'extra_fields': ['document_id', 'document_reason']
        },
        'other': {
            'show_amount': false,
            'required_fields': ['title', 'description', 'priority'],
            'extra_fields': []
        }
    };
    
    // Helper to show toast
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
        
        if (type === 'success') {
            toastEl.classList.add('bg-success');
            toastIcon.className = 'bi bi-check-circle me-2';
        } else if (type === 'error') {
            toastEl.classList.add('bg-danger');
            toastIcon.className = 'bi bi-exclamation-circle me-2';
        } else if (type === 'warning') {
            toastEl.classList.add('bg-warning');
            toastIcon.className = 'bi bi-exclamation-triangle me-2';
        } else {
            toastEl.classList.add('bg-info');
            toastIcon.className = 'bi bi-info-circle me-2';
        }
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    
    // Show modal state
    function showModalState(state) {
        webauthnInitial.style.display = state === 'initial' ? 'block' : 'none';
        webauthnProcessing.style.display = state === 'processing' ? 'block' : 'none';
        webauthnSuccess.style.display = state === 'success' ? 'block' : 'none';
        webauthnError.style.display = state === 'error' ? 'block' : 'none';
        
        webauthnConfirmBtn.style.display = state === 'initial' ? 'inline-block' : 'none';
        webauthnRetryBtn.style.display = state === 'error' ? 'inline-block' : 'none';
        webauthnCancelBtn.style.display = ['initial', 'error'].includes(state) ? 'inline-block' : 'none';
    }
    
    // Base64 helpers
    function base64ToBuffer(base64) {
        const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
        const buffer = new ArrayBuffer(binary.length);
        const view = new Uint8Array(buffer);
        for (let i = 0; i < binary.length; i++) {
            view[i] = binary.charCodeAt(i);
        }
        return buffer;
    }

    function bufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        const chunkSize = 8192;
        for (let i = 0; i < bytes.byteLength; i += chunkSize) {
            const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.byteLength));
            binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    // Perform WebAuthn authentication
    async function performWebAuthn() {
        showModalState('processing');
        
        try {
            // Get form data for context
            const formData = new FormData(form);
            const contextData = {
                title: formData.get('title') || '',
                category: formData.get('category') || '',
                amount: formData.get('amount') || '',
            };
            
            // Step 1: Get WebAuthn options
            const optionsResponse = await fetch(webauthnOptionsUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(contextData)
            });

            if (!optionsResponse.ok) {
                const errorData = await optionsResponse.json();
                if (errorData.noCredentials) {
                    throw new Error('{% trans "No biometric credentials registered. Please register a device from your profile first." %}');
                }
                throw new Error(errorData.error || '{% trans "Failed to get authentication options" %}');
            }

            const optionsResult = await optionsResponse.json();
            const { options } = optionsResult;
            creationToken = optionsResult.creationToken;

            // Step 2: Prepare WebAuthn options
            const publicKey = {
                challenge: base64ToBuffer(options.challenge),
                timeout: options.timeout || 60000,
                rpId: options.rpId,
                allowCredentials: (options.allowCredentials || []).map(cred => ({
                    type: cred.type,
                    id: base64ToBuffer(cred.id),
                    transports: cred.transports || []
                })),
                userVerification: options.userVerification || 'required'
            };

            // Step 3: Show biometric prompt
            const assertion = await navigator.credentials.get({ publicKey });

            if (!assertion) {
                throw new Error('{% trans "WebAuthn authentication was cancelled" %}');
            }

            // Step 4: Prepare assertion data
            const assertionData = {
                id: assertion.id,
                rawId: bufferToBase64(assertion.rawId),
                response: {
                    clientDataJSON: bufferToBase64(assertion.response.clientDataJSON),
                    authenticatorData: bufferToBase64(assertion.response.authenticatorData),
                    signature: bufferToBase64(assertion.response.signature),
                    userHandle: assertion.response.userHandle ? bufferToBase64(assertion.response.userHandle) : null,
                },
                type: assertion.type
            };

            // Step 5: Verify WebAuthn response
            const verifyResponse = await fetch(webauthnVerifyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    creationToken: creationToken,
                    response: assertionData
                })
            });

            if (!verifyResponse.ok) {
                const errorData = await verifyResponse.json();
                throw new Error(errorData.error || '{% trans "Authentication verification failed" %}');
            }

            const verifyResult = await verifyResponse.json();

            if (!verifyResult.success) {
                throw new Error(verifyResult.error || '{% trans "Verification failed" %}');
            }

            // Step 6: Success - set token and submit form
            showModalState('success');
            verifiedTokenField.value = verifyResult.verifiedToken;
            
            // Short delay to show success message, then submit directly
            setTimeout(() => {
                webauthnModal.hide();
                // Use native submit to bypass event listeners
                HTMLFormElement.prototype.submit.call(form);
            }, 800);

        } catch (error) {
            console.error('WebAuthn error:', error);
            
            let errorMsg = error.message;
            if (error.name === 'NotAllowedError') {
                errorMsg = '{% trans "Biometric authentication was cancelled or denied. Please try again." %}';
            } else if (error.name === 'InvalidStateError') {
                errorMsg = '{% trans "No matching credential found on this device." %}';
            } else if (error.name === 'NotSupportedError') {
                errorMsg = '{% trans "This device does not support the required authentication method." %}';
            }
            
            webauthnErrorMessage.textContent = errorMsg;
            showModalState('error');
        }
    }
    
    // Event handlers for WebAuthn modal
    webauthnConfirmBtn.addEventListener('click', performWebAuthn);
    webauthnRetryBtn.addEventListener('click', function() {
        showModalState('initial');
    });
    
    // Reset modal state when closed
    document.getElementById('webauthnModal').addEventListener('hidden.bs.modal', function() {
        showModalState('initial');
        creationToken = null;
    });
    
    function updateFormFields() {
        const category = categoryField.value;
        const config = categoryConfigs[category] || categoryConfigs['other'];
        
        // Show/hide amount field
        if (config.show_amount) {
            if (amountField) {
                amountField.style.display = 'block';
                const amountInput = document.getElementById('id_amount');
                if (amountInput) amountInput.required = true;
            }
        } else {
            if (amountField) {
                amountField.style.display = 'none';
                const amountInput = document.getElementById('id_amount');
                if (amountInput) {
                    amountInput.required = false;
                    amountInput.value = '';
                }
            }
        }
        
        // Show/hide dynamic field groups
        document.querySelectorAll('.dynamic-group').forEach(group => {
            const groupCategory = group.getAttribute('data-category');
            if (groupCategory === category) {
                group.style.display = 'block';
                // Set required attributes for fields in this group
                group.querySelectorAll('input, select, textarea').forEach(field => {
                    const fieldName = field.name;
                    if (config.required_fields.includes(fieldName)) {
                        field.required = true;
                    }
                });
            } else {
                group.style.display = 'none';
                // Remove required attributes and clear values
                group.querySelectorAll('input, select, textarea').forEach(field => {
                    field.required = false;
                    if (field.type !== 'hidden') {
                        field.value = '';
                    }
                });
            }
        });
        
        // Update category help highlighting
        document.querySelectorAll('.category-item').forEach(item => {
            const itemCategory = item.getAttribute('data-category');
            if (itemCategory === category) {
                item.classList.add('active');
                item.style.backgroundColor = 'rgba(79, 70, 229, 0.05)';
                item.style.borderColor = 'rgba(79, 70, 229, 0.2)';
            } else {
                item.classList.remove('active');
                item.style.backgroundColor = '';
                item.style.borderColor = 'transparent';
            }
        });
        
        updatePreview();
    }
    
    function updatePreview() {
        const formData = new FormData(form);
        const category = formData.get('category');
        const title = formData.get('title');
        const description = formData.get('description');
        const amount = formData.get('amount');
        const priority = formData.get('priority');
        
        if (!title && !description) {
            previewCard.style.display = 'none';
            return;
        }
        
        previewCard.style.display = 'block';
        
        let previewHtml = '';
        
        if (title) {
            previewHtml += `<h6 class="fw-bold mb-1" style="font-size: var(--font-base);">${title}</h6>`;
        }
        
        if (description) {
            previewHtml += `<p class="text-muted mb-3" style="font-size: var(--font-sm);">${description}</p>`;
        }
        
        previewHtml += '<div class="row g-2">';
        
        if (category) {
            const categoryDisplay = categoryField.options[categoryField.selectedIndex].text;
            previewHtml += `
                <div class="col-6">
                    <small class="text-muted d-block mb-1" style="font-size: var(--font-xs);">{% trans "Category" %}</small>
                    <span class="badge bg-primary-custom fw-normal" style="font-size: var(--font-xs);">${categoryDisplay}</span>
                </div>
            `;
        }
        
        if (priority) {
            const prioritySelect = document.getElementById('id_priority');
            const priorityDisplay = prioritySelect.options[prioritySelect.selectedIndex].text;
            let priorityClass = 'bg-success';
            if (priority === 'high') priorityClass = 'bg-danger';
            else if (priority === 'medium') priorityClass = 'bg-warning text-dark';
            
            previewHtml += `
                <div class="col-6">
                    <small class="text-muted d-block mb-1" style="font-size: var(--font-xs);">{% trans "Priority" %}</small>
                    <span class="badge ${priorityClass} fw-normal" style="font-size: var(--font-xs);">${priorityDisplay}</span>
                </div>
            `;
        }
        
        previewHtml += '</div>';
        
        if (amount && categoryConfigs[category]?.show_amount) {
            previewHtml += `
                <div class="mt-3 pt-2 border-top">
                    <small class="text-muted d-block mb-1" style="font-size: var(--font-xs);">{% trans "Amount" %}</small>
                    <strong class="text-dark" style="font-size: var(--font-lg);">$${parseFloat(amount).toLocaleString()}</strong>
                </div>
            `;
        }
        
        previewContent.innerHTML = previewHtml;
    }
    
    // Event listeners
    if (categoryField) {
        categoryField.addEventListener('change', updateFormFields);
    }
    
    // Update preview on form changes
    if (form) {
        form.addEventListener('input', updatePreview);
        form.addEventListener('change', updatePreview);
        
        // Form submission - intercept and show WebAuthn modal
        form.addEventListener('submit', function(e) {
            const category = categoryField.value;
            const config = categoryConfigs[category] || categoryConfigs['other'];
            
            let hasErrors = false;
            
            // Validate required fields
            config.required_fields.forEach(fieldName => {
                const field = document.getElementById('id_' + fieldName);
                if (field && !field.value.trim()) {
                    field.classList.add('field-error');
                    hasErrors = true;
                } else if (field) {
                    field.classList.remove('field-error');
                }
            });
            
            if (hasErrors) {
                e.preventDefault();
                showToast('{% trans "Please fill in all required fields." %}', 'warning');
                return;
            }
            
            // If we're submitting after WebAuthn verification, allow it
            if (isSubmittingAfterWebAuthn && verifiedTokenField.value) {
                // Reset flag and allow form submission
                isSubmittingAfterWebAuthn = false;
                return; // Allow the form to submit naturally
            }
            
            // If we don't have a verified token yet, show WebAuthn modal
            if (!verifiedTokenField.value) {
                e.preventDefault();
                
                // Check if WebAuthn is supported
                if (!navigator.credentials || !navigator.credentials.get) {
                    showToast('{% trans "WebAuthn is not supported on this device/browser." %}', 'error');
                    return;
                }
                
                // Show WebAuthn modal
                webauthnModal.show();
            }
        });
    }
    
    // Initialize form
    if (categoryField) {
        updateFormFields();
    }
});
</script>
{% endblock %}