{% extends 'base.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "New Request" %} - SecureApprove{% endblock %}

{% block extra_css %}
<style>
    /* ===== Page Layout ===== */
    .create-request-page {
        min-height: calc(100vh - 120px);
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-color) 100%);
    }
    
    .page-header {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
    }
    
    .page-header .container-fluid {
        max-width: 1400px;
    }

    /* ===== Step Indicators ===== */
    .step-indicators {
        display: flex;
        justify-content: center;
        gap: 0;
        margin-bottom: 2rem;
        padding: 0 1rem;
    }
    
    .step-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .step-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: var(--font-sm);
        background: var(--bg-secondary);
        color: var(--text-muted);
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
    }
    
    .step-item.active .step-circle {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
    }
    
    .step-item.completed .step-circle {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }
    
    .step-label {
        font-size: var(--font-sm);
        color: var(--text-muted);
        font-weight: 500;
        display: none;
    }
    
    @media (min-width: 768px) {
        .step-label {
            display: block;
        }
    }
    
    .step-item.active .step-label {
        color: var(--primary-color);
    }
    
    .step-item.completed .step-label {
        color: var(--success-color);
    }
    
    .step-connector {
        width: 60px;
        height: 2px;
        background: var(--border-color);
        margin: 0 0.5rem;
    }
    
    .step-connector.completed {
        background: var(--success-color);
    }

    /* ===== Category Selection Cards ===== */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    @media (min-width: 768px) {
        .category-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (min-width: 992px) {
        .category-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
    
    .category-card {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .category-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }
    
    .category-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(79, 70, 229, 0.02) 100%);
    }
    
    .category-card.selected::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 32px 32px 0;
        border-color: transparent var(--primary-color) transparent transparent;
    }
    
    .category-card.selected::before {
        content: 'âœ“';
        position: absolute;
        top: 2px;
        right: 5px;
        color: white;
        font-size: 10px;
        font-weight: bold;
        z-index: 1;
    }
    
    .category-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        font-size: 1.25rem;
    }
    
    .category-card[data-category="expense"] .category-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .category-card[data-category="purchase"] .category-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .category-card[data-category="travel"] .category-icon { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
    .category-card[data-category="contract"] .category-icon { background: rgba(249, 115, 22, 0.1); color: #f97316; }
    .category-card[data-category="document"] .category-icon { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
    .category-card[data-category="other"] .category-icon { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
    
    .category-card.selected[data-category="expense"] { border-color: #10b981; }
    .category-card.selected[data-category="expense"]::after { border-color: transparent #10b981 transparent transparent; }
    .category-card.selected[data-category="purchase"] { border-color: #3b82f6; }
    .category-card.selected[data-category="purchase"]::after { border-color: transparent #3b82f6 transparent transparent; }
    .category-card.selected[data-category="travel"] { border-color: #a855f7; }
    .category-card.selected[data-category="travel"]::after { border-color: transparent #a855f7 transparent transparent; }
    .category-card.selected[data-category="contract"] { border-color: #f97316; }
    .category-card.selected[data-category="contract"]::after { border-color: transparent #f97316 transparent transparent; }
    .category-card.selected[data-category="document"] { border-color: #ec4899; }
    .category-card.selected[data-category="document"]::after { border-color: transparent #ec4899 transparent transparent; }
    .category-card.selected[data-category="other"] { border-color: #6b7280; }
    .category-card.selected[data-category="other"]::after { border-color: transparent #6b7280 transparent transparent; }
    
    .category-name {
        font-weight: 600;
        font-size: var(--font-sm);
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .category-hint {
        font-size: var(--font-xs);
        color: var(--text-muted);
        line-height: 1.3;
    }

    /* ===== Form Card ===== */
    .form-card {
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        overflow: hidden;
    }
    
    .form-card-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .form-card-header i {
        font-size: 1.25rem;
        opacity: 0.9;
    }
    
    .form-card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: var(--font-base);
    }
    
    .form-card-body {
        padding: 1.5rem;
    }

    /* ===== Form Controls ===== */
    .form-floating-custom {
        position: relative;
        margin-bottom: 1.25rem;
    }
    
    .form-floating-custom .form-control,
    .form-floating-custom .form-select {
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 10px;
        padding: 0.875rem 1rem;
        font-size: var(--font-sm);
        transition: all 0.2s ease;
        color: var(--text-color);
    }
    
    .form-floating-custom .form-control:focus,
    .form-floating-custom .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        background: var(--card-bg);
    }
    
    .form-floating-custom .form-label {
        font-size: var(--font-sm);
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-floating-custom .form-label .required {
        color: var(--danger-color);
    }
    
    .form-floating-custom .form-label i {
        color: var(--text-muted);
        font-size: var(--font-sm);
    }

    /* ===== Dynamic Groups ===== */
    .dynamic-group {
        transition: all 0.3s ease;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== Field Error ===== */
    .field-error {
        border-color: var(--danger-color) !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15) !important;
    }

    /* ===== Priority Badges ===== */
    .priority-selector {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }
    
    .priority-option {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--card-bg);
    }
    
    .priority-option:hover {
        border-color: var(--text-muted);
    }
    
    .priority-option.selected {
        border-width: 2px;
    }
    
    .priority-option.selected[data-priority="low"] {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
    }
    
    .priority-option.selected[data-priority="medium"] {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }
    
    .priority-option.selected[data-priority="high"] {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }
    
    .priority-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .priority-option[data-priority="low"] .priority-dot { background: #10b981; }
    .priority-option[data-priority="medium"] .priority-dot { background: #f59e0b; }
    .priority-option[data-priority="high"] .priority-dot { background: #ef4444; }

    /* ===== File Upload ===== */
    .file-upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background: var(--bg-secondary);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .file-upload-zone:hover,
    .file-upload-zone.dragover {
        border-color: var(--primary-color);
        background: rgba(79, 70, 229, 0.02);
    }
    
    .file-upload-zone i {
        font-size: 2.5rem;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }
    
    .file-list {
        margin-top: 1rem;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .file-item i {
        color: var(--primary-color);
    }
    
    .file-item .file-name {
        flex: 1;
        font-size: var(--font-sm);
        color: var(--text-color);
    }
    
    .file-item .file-size {
        font-size: var(--font-xs);
        color: var(--text-muted);
    }
    
    .file-item .remove-file {
        color: var(--danger-color);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .file-item .remove-file:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    /* ===== Preview Sidebar ===== */
    .preview-sidebar {
        position: sticky;
        top: 100px;
    }
    
    .preview-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .preview-header {
        background: var(--bg-secondary);
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .preview-header i {
        color: var(--primary-color);
    }
    
    .preview-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: var(--font-sm);
    }
    
    .preview-body {
        padding: 1.25rem;
    }
    
    .preview-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-muted);
    }
    
    .preview-empty i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }
    
    .preview-field {
        margin-bottom: 1rem;
    }
    
    .preview-field:last-child {
        margin-bottom: 0;
    }
    
    .preview-label {
        font-size: var(--font-xs);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    
    .preview-value {
        font-size: var(--font-sm);
        color: var(--text-color);
        font-weight: 500;
    }
    
    .preview-amount {
        font-size: var(--font-xl);
        font-weight: 700;
        color: var(--primary-color);
    }

    /* ===== Submit Button ===== */
    .submit-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    
    .btn-submit {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        border: none;
        color: white;
        padding: 0.875rem 2rem;
        font-size: var(--font-base);
        font-weight: 600;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.2s ease;
        box-shadow: 0 4px 14px rgba(79, 70, 229, 0.25);
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.35);
        color: white;
    }
    
    .btn-submit:active {
        transform: translateY(0);
    }
    
    .btn-submit i {
        font-size: 1.1rem;
    }

    /* ===== WebAuthn Modal Styles ===== */
    .webauthn-status {
        text-align: center;
        padding: 2rem;
    }
    
    .webauthn-status .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .webauthn-status .bi-fingerprint {
        font-size: 4rem;
        color: var(--primary-color);
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    .webauthn-success .bi-check-circle-fill {
        font-size: 4rem;
        color: var(--success-color);
    }
    
    .webauthn-error .bi-x-circle-fill {
        font-size: 4rem;
        color: var(--danger-color);
    }

    /* ===== Hide default crispy form elements ===== */
    #div_id_category,
    #div_id_priority,
    #div_id_attachments {
        display: none;
    }
    
    /* ===== Responsive Adjustments ===== */
    @media (max-width: 991px) {
        .preview-sidebar {
            position: static;
            margin-top: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="create-request-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 fw-bold">
                        <i class="bi bi-plus-circle me-2 text-primary"></i>
                        {% trans "New Request" %}
                    </h1>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Submit a new approval request for review" %}
                    </p>
                </div>
                <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary d-flex align-items-center gap-2">
                    <i class="bi bi-arrow-left"></i>
                    <span class="d-none d-sm-inline">{% trans "Back to Requests" %}</span>
                </a>
            </div>
        </div>
    </div>

    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Step Indicators -->
        <div class="step-indicators">
            <div class="step-item active" data-step="1">
                <div class="step-circle">1</div>
                <span class="step-label">{% trans "Category" %}</span>
            </div>
            <div class="step-connector"></div>
            <div class="step-item" data-step="2">
                <div class="step-circle">2</div>
                <span class="step-label">{% trans "Details" %}</span>
            </div>
            <div class="step-connector"></div>
            <div class="step-item" data-step="3">
                <div class="step-circle">3</div>
                <span class="step-label">{% trans "Review" %}</span>
            </div>
        </div>

        <form method="post" id="request-form" novalidate enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="webauthn_verified_token" name="webauthn_verified_token" value="">
            <input type="hidden" id="id_category" name="category" value="expense">
            <input type="hidden" id="id_priority" name="priority" value="medium">
            
            <div class="row g-4">
                <div class="col-lg-8">
                    <!-- Step 1: Category Selection -->
                    <div class="form-card mb-4" id="step-1-card">
                        <div class="form-card-header">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <h5>{% trans "Select Request Category" %}</h5>
                        </div>
                        <div class="form-card-body">
                            <p class="text-muted mb-3" style="font-size: var(--font-sm);">
                                {% trans "Choose the type of request you want to submit" %}
                            </p>
                            <div class="category-grid">
                                <div class="category-card selected" data-category="expense">
                                    <div class="category-icon">
                                        <i class="bi bi-receipt"></i>
                                    </div>
                                    <div class="category-name">{% trans "Expense" %}</div>
                                    <div class="category-hint">{% trans "Reimbursements" %}</div>
                                </div>
                                <div class="category-card" data-category="purchase">
                                    <div class="category-icon">
                                        <i class="bi bi-cart3"></i>
                                    </div>
                                    <div class="category-name">{% trans "Purchase" %}</div>
                                    <div class="category-hint">{% trans "Equipment & supplies" %}</div>
                                </div>
                                <div class="category-card" data-category="travel">
                                    <div class="category-icon">
                                        <i class="bi bi-airplane"></i>
                                    </div>
                                    <div class="category-name">{% trans "Travel" %}</div>
                                    <div class="category-hint">{% trans "Trips & logistics" %}</div>
                                </div>
                                <div class="category-card" data-category="contract">
                                    <div class="category-icon">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </div>
                                    <div class="category-name">{% trans "Contract" %}</div>
                                    <div class="category-hint">{% trans "Agreements" %}</div>
                                </div>
                                <div class="category-card" data-category="document">
                                    <div class="category-icon">
                                        <i class="bi bi-file-earmark-check"></i>
                                    </div>
                                    <div class="category-name">{% trans "Document" %}</div>
                                    <div class="category-hint">{% trans "Approvals" %}</div>
                                </div>
                                <div class="category-card" data-category="other">
                                    <div class="category-icon">
                                        <i class="bi bi-three-dots"></i>
                                    </div>
                                    <div class="category-name">{% trans "Other" %}</div>
                                    <div class="category-hint">{% trans "General" %}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Request Details -->
                    <div class="form-card mb-4" id="step-2-card">
                        <div class="form-card-header">
                            <i class="bi bi-pencil-square"></i>
                            <h5>{% trans "Request Details" %}</h5>
                        </div>
                        <div class="form-card-body">
                            <!-- Title -->
                            <div class="form-floating-custom">
                                <label class="form-label" for="id_title">
                                    <i class="bi bi-type"></i>
                                    {% trans "Title" %}
                                    <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="id_title" name="title" 
                                       placeholder="{% trans 'Enter a descriptive title for your request' %}" required>
                            </div>

                            <!-- Description -->
                            <div class="form-floating-custom">
                                <label class="form-label" for="id_description">
                                    <i class="bi bi-text-paragraph"></i>
                                    {% trans "Description" %}
                                    <span class="required">*</span>
                                </label>
                                <textarea class="form-control" id="id_description" name="description" rows="4"
                                          placeholder="{% trans 'Provide detailed information about your request' %}" required></textarea>
                            </div>

                            <!-- Priority -->
                            <div class="form-floating-custom">
                                <label class="form-label">
                                    <i class="bi bi-flag"></i>
                                    {% trans "Priority" %}
                                </label>
                                <div class="priority-selector">
                                    <div class="priority-option" data-priority="low">
                                        <span class="priority-dot"></span>
                                        <span>{% trans "Low" %}</span>
                                    </div>
                                    <div class="priority-option selected" data-priority="medium">
                                        <span class="priority-dot"></span>
                                        <span>{% trans "Medium" %}</span>
                                    </div>
                                    <div class="priority-option" data-priority="high">
                                        <span class="priority-dot"></span>
                                        <span>{% trans "High" %}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Amount (conditional) -->
                            <div class="form-floating-custom" id="amount-field">
                                <label class="form-label" for="id_amount">
                                    <i class="bi bi-currency-dollar"></i>
                                    {% trans "Amount" %}
                                    <span class="required">*</span>
                                </label>
                                <input type="number" class="form-control" id="id_amount" name="amount" 
                                       step="0.01" min="0" placeholder="0.00">
                            </div>

                            <!-- Dynamic Category Fields -->
                            <div id="dynamic-fields">
                                <!-- Expense fields -->
                                <div class="dynamic-group" data-category="expense">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating-custom mb-0">
                                                <label class="form-label" for="id_expense_category">
                                                    <i class="bi bi-tag"></i>
                                                    {% trans "Expense Category" %}
                                                </label>
                                                <input type="text" class="form-control" id="id_expense_category" 
                                                       name="expense_category" placeholder="{% trans 'Meals, Transportation, etc.' %}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating-custom mb-0">
                                                <label class="form-label" for="id_receipt_ref">
                                                    <i class="bi bi-receipt"></i>
                                                    {% trans "Receipt Reference" %}
                                                </label>
                                                <input type="text" class="form-control" id="id_receipt_ref" 
                                                       name="receipt_ref" placeholder="{% trans 'Receipt number' %}">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Purchase fields -->
                                <div class="dynamic-group" data-category="purchase" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating-custom mb-0">
                                                <label class="form-label" for="id_purchase_vendor">
                                                    <i class="bi bi-building"></i>
                                                    {% trans "Vendor" %}
                                                </label>
                                                <input type="text" class="form-control" id="id_purchase_vendor" 
                                                       name="purchase_vendor" placeholder="{% trans 'Vendor name' %}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating-custom mb-0">
                                                <label class="form-label" for="id_cost_center">
                                                    <i class="bi bi-diagram-3"></i>
                                                    {% trans "Cost Center" %}
                                                </label>
                                                <input type="text" class="form-control" id="id_cost_center" 
                                                       name="cost_center" placeholder="{% trans 'Cost center code' %}">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Travel fields -->
                                <div class="dynamic-group" data-category="travel" style="display: none;">
                                    <div class="form-floating-custom">
                                        <label class="form-label" for="id_destination">
                                            <i class="bi bi-geo-alt"></i>
                                            {% trans "Destination" %}
                                        </label>
                                        <input type="text" class="form-control" id="id_destination" 
                                               name="destination" placeholder="{% trans 'Travel destination' %}">
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating-custom mb-0">
                                                <label class="form-label" for="id_start_date">
                                                    <i class="bi bi-calendar-event"></i>
                                                    {% trans "Start Date" %}
                                                </label>
                                                <input type="date" class="form-control" id="id_start_date" name="start_date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating-custom mb-0">
                                                <label class="form-label" for="id_end_date">
                                                    <i class="bi bi-calendar-check"></i>
                                                    {% trans "End Date" %}
                                                </label>
                                                <input type="date" class="form-control" id="id_end_date" name="end_date">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contract fields -->
                                <div class="dynamic-group" data-category="contract" style="display: none;">
                                    <div class="form-floating-custom">
                                        <label class="form-label" for="id_contract_vendor">
                                            <i class="bi bi-building"></i>
                                            {% trans "Vendor" %}
                                        </label>
                                        <input type="text" class="form-control" id="id_contract_vendor" 
                                               name="contract_vendor" placeholder="{% trans 'Vendor name' %}">
                                    </div>
                                    <div class="form-floating-custom mb-0">
                                        <label class="form-label" for="id_contract_reason">
                                            <i class="bi bi-chat-left-text"></i>
                                            {% trans "Reason" %}
                                        </label>
                                        <textarea class="form-control" id="id_contract_reason" name="contract_reason" 
                                                  rows="3" placeholder="{% trans 'Explain the reason for this request' %}"></textarea>
                                    </div>
                                </div>

                                <!-- Document fields -->
                                <div class="dynamic-group" data-category="document" style="display: none;">
                                    <div class="form-floating-custom">
                                        <label class="form-label" for="id_document_id">
                                            <i class="bi bi-file-earmark"></i>
                                            {% trans "Document ID" %}
                                        </label>
                                        <input type="text" class="form-control" id="id_document_id" 
                                               name="document_id" placeholder="{% trans 'Document ID or reference' %}">
                                    </div>
                                    <div class="form-floating-custom mb-0">
                                        <label class="form-label" for="id_document_reason">
                                            <i class="bi bi-chat-left-text"></i>
                                            {% trans "Reason" %}
                                        </label>
                                        <textarea class="form-control" id="id_document_reason" name="document_reason" 
                                                  rows="3" placeholder="{% trans 'Explain the reason for this request' %}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Attachments -->
                    <div class="form-card mb-4" id="step-3-card">
                        <div class="form-card-header">
                            <i class="bi bi-paperclip"></i>
                            <h5>{% trans "Attachments" %}</h5>
                        </div>
                        <div class="form-card-body">
                            <div class="file-upload-zone" id="file-upload-zone">
                                <input type="file" id="id_attachments" name="attachments" multiple 
                                       class="d-none" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif">
                                <i class="bi bi-cloud-arrow-up d-block"></i>
                                <p class="mb-1 fw-medium" style="font-size: var(--font-sm);">
                                    {% trans "Drag and drop files here or click to browse" %}
                                </p>
                                <p class="text-muted mb-0" style="font-size: var(--font-xs);">
                                    {% trans "PDF, Word, Excel, Images (Max 25MB per file)" %}
                                </p>
                            </div>
                            <div class="file-list" id="file-list"></div>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="submit-section d-flex justify-content-between align-items-center">
                        <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-2"></i>
                            {% trans "Cancel" %}
                        </a>
                        <button type="submit" class="btn-submit">
                            <i class="bi bi-shield-check"></i>
                            {% trans "Submit Request" %}
                        </button>
                    </div>
                </div>

                <!-- Preview Sidebar -->
                <div class="col-lg-4">
                    <div class="preview-sidebar">
                        <div class="preview-card" id="preview-card">
                            <div class="preview-header">
                                <i class="bi bi-eye"></i>
                                <h6>{% trans "Request Preview" %}</h6>
                            </div>
                            <div class="preview-body" id="preview-content">
                                <div class="preview-empty">
                                    <i class="bi bi-file-earmark-text d-block"></i>
                                    <p class="mb-0" style="font-size: var(--font-sm);">
                                        {% trans "Fill in the form to see a preview" %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- WebAuthn Confirmation Modal -->
<div class="modal fade" id="webauthnModal" tabindex="-1" aria-labelledby="webauthnModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="webauthnModalLabel">
                    <i class="bi bi-shield-lock me-2"></i>
                    {% trans "Confirm Your Identity" %}
                </h5>
            </div>
            <div class="modal-body">
                <!-- Initial State -->
                <div id="webauthn-initial" class="webauthn-status">
                    <div class="mb-4">
                        <i class="bi bi-fingerprint"></i>
                    </div>
                    <h6 class="mb-2">{% trans "Biometric Verification Required" %}</h6>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Please authenticate using your fingerprint, face recognition, or security key to submit this request." %}
                    </p>
                </div>
                
                <!-- Processing State -->
                <div id="webauthn-processing" class="webauthn-status" style="display: none;">
                    <div class="mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{% trans "Loading..." %}</span>
                        </div>
                    </div>
                    <h6 class="mb-2">{% trans "Waiting for authentication..." %}</h6>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Please complete the biometric prompt on your device." %}
                    </p>
                </div>
                
                <!-- Success State -->
                <div id="webauthn-success" class="webauthn-status webauthn-success" style="display: none;">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h6 class="mb-2 text-success">{% trans "Authentication Successful" %}</h6>
                    <p class="text-muted mb-0" style="font-size: var(--font-sm);">
                        {% trans "Submitting your request..." %}
                    </p>
                </div>
                
                <!-- Error State -->
                <div id="webauthn-error" class="webauthn-status webauthn-error" style="display: none;">
                    <div class="mb-4">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <h6 class="mb-2 text-danger">{% trans "Authentication Failed" %}</h6>
                    <p class="text-muted mb-0" id="webauthn-error-message" style="font-size: var(--font-sm);">
                        {% trans "Please try again." %}
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" id="webauthn-cancel-btn" data-bs-dismiss="modal">
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" id="webauthn-confirm-btn">
                    <i class="bi bi-fingerprint me-2"></i>
                    {% trans "Authenticate" %}
                </button>
                <button type="button" class="btn btn-primary" id="webauthn-retry-btn" style="display: none;">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    {% trans "Try Again" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
                <i class="bi bi-info-circle me-2" id="toast-icon"></i>
                <span id="toast-message"></span>
            </div>
            <button type="button" class="btn-close me-2 m-auto" id="toast-close-btn" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form Elements
    const form = document.getElementById('request-form');
    const categoryField = document.getElementById('id_category');
    const priorityField = document.getElementById('id_priority');
    const amountField = document.getElementById('amount-field');
    const previewContent = document.getElementById('preview-content');
    const verifiedTokenField = document.getElementById('webauthn_verified_token');
    const fileInput = document.getElementById('id_attachments');
    const fileUploadZone = document.getElementById('file-upload-zone');
    const fileList = document.getElementById('file-list');
    
    // Category Cards
    const categoryCards = document.querySelectorAll('.category-card');
    
    // Priority Options
    const priorityOptions = document.querySelectorAll('.priority-option');
    
    // Step indicators
    const stepItems = document.querySelectorAll('.step-item');
    const stepConnectors = document.querySelectorAll('.step-connector');
    
    // WebAuthn Modal Elements
    const webauthnModal = new bootstrap.Modal(document.getElementById('webauthnModal'));
    const webauthnInitial = document.getElementById('webauthn-initial');
    const webauthnProcessing = document.getElementById('webauthn-processing');
    const webauthnSuccess = document.getElementById('webauthn-success');
    const webauthnError = document.getElementById('webauthn-error');
    const webauthnErrorMessage = document.getElementById('webauthn-error-message');
    const webauthnConfirmBtn = document.getElementById('webauthn-confirm-btn');
    const webauthnRetryBtn = document.getElementById('webauthn-retry-btn');
    const webauthnCancelBtn = document.getElementById('webauthn-cancel-btn');
    
    // Toast elements
    const toastEl = document.getElementById('notification-toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');
    
    // WebAuthn URLs
    const webauthnOptionsUrl = "{% url 'requests:create-webauthn-options' %}";
    const webauthnVerifyUrl = "{% url 'requests:create-webauthn-verify' %}";
    
    // State
    let creationToken = null;
    let selectedFiles = [];
    
    // Category configurations
    const categoryConfigs = {
        'expense': {
            'show_amount': true,
            'required_fields': ['title', 'description', 'amount', 'priority'],
            'extra_fields': ['expense_category', 'receipt_ref']
        },
        'purchase': {
            'show_amount': true,
            'required_fields': ['title', 'description', 'amount', 'priority'],
            'extra_fields': ['purchase_vendor', 'cost_center']
        },
        'travel': {
            'show_amount': true,
            'required_fields': ['title', 'description', 'amount', 'priority'],
            'extra_fields': ['destination', 'start_date', 'end_date']
        },
        'contract': {
            'show_amount': false,
            'required_fields': ['title', 'description', 'priority'],
            'extra_fields': ['contract_vendor', 'contract_reason']
        },
        'document': {
            'show_amount': false,
            'required_fields': ['title', 'description', 'priority'],
            'extra_fields': ['document_id', 'document_reason']
        },
        'other': {
            'show_amount': false,
            'required_fields': ['title', 'description', 'priority'],
            'extra_fields': []
        }
    };
    
    const categoryNames = {
        'expense': '{% trans "Expense" %}',
        'purchase': '{% trans "Purchase" %}',
        'travel': '{% trans "Travel" %}',
        'contract': '{% trans "Contract" %}',
        'document': '{% trans "Document" %}',
        'other': '{% trans "Other" %}'
    };
    
    const priorityNames = {
        'low': '{% trans "Low" %}',
        'medium': '{% trans "Medium" %}',
        'high': '{% trans "High" %}'
    };
    
    // ===== Category Selection =====
    categoryCards.forEach(card => {
        card.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            
            // Update hidden field
            categoryField.value = category;
            
            // Update visual state
            categoryCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            
            // Update form fields
            updateFormFields();
            
            // Update step indicator
            updateStepIndicator(2);
        });
    });
    
    // ===== Priority Selection =====
    priorityOptions.forEach(option => {
        option.addEventListener('click', function() {
            const priority = this.getAttribute('data-priority');
            
            // Update hidden field
            priorityField.value = priority;
            
            // Update visual state
            priorityOptions.forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            
            // Update preview
            updatePreview();
        });
    });
    
    // ===== File Upload =====
    fileUploadZone.addEventListener('click', () => fileInput.click());
    
    fileUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZone.classList.add('dragover');
    });
    
    fileUploadZone.addEventListener('dragleave', () => {
        fileUploadZone.classList.remove('dragover');
    });
    
    fileUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
    
    function handleFiles(files) {
        for (let file of files) {
            if (file.size > 25 * 1024 * 1024) {
                showToast(`{% trans "File is too large" %}: ${file.name}`, 'error');
                continue;
            }
            selectedFiles.push(file);
        }
        renderFileList();
        updateStepIndicator(3);
    }
    
    function renderFileList() {
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const size = formatFileSize(file.size);
            const icon = getFileIcon(file.name);
            fileList.innerHTML += `
                <div class="file-item">
                    <i class="bi ${icon}"></i>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${size}</span>
                    <span class="remove-file" data-index="${index}">
                        <i class="bi bi-x-lg"></i>
                    </span>
                </div>
            `;
        });
        
        // Add remove handlers
        fileList.querySelectorAll('.remove-file').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                selectedFiles.splice(index, 1);
                renderFileList();
                updateFileInput();
            });
        });
    }
    
    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'bi-file-pdf',
            'doc': 'bi-file-word',
            'docx': 'bi-file-word',
            'xls': 'bi-file-excel',
            'xlsx': 'bi-file-excel',
            'png': 'bi-file-image',
            'jpg': 'bi-file-image',
            'jpeg': 'bi-file-image',
            'gif': 'bi-file-image'
        };
        return icons[ext] || 'bi-file-earmark';
    }
    
    // ===== Step Indicator =====
    function updateStepIndicator(currentStep) {
        stepItems.forEach((item, index) => {
            const step = index + 1;
            item.classList.remove('active', 'completed');
            
            if (step < currentStep) {
                item.classList.add('completed');
            } else if (step === currentStep) {
                item.classList.add('active');
            }
        });
        
        stepConnectors.forEach((connector, index) => {
            connector.classList.remove('completed');
            if (index < currentStep - 1) {
                connector.classList.add('completed');
            }
        });
    }
    
    // ===== Form Fields Update =====
    function updateFormFields() {
        const category = categoryField.value;
        const config = categoryConfigs[category] || categoryConfigs['other'];
        
        // Show/hide amount field
        if (config.show_amount) {
            amountField.style.display = 'block';
        } else {
            amountField.style.display = 'none';
            document.getElementById('id_amount').value = '';
        }
        
        // Show/hide dynamic field groups
        document.querySelectorAll('.dynamic-group').forEach(group => {
            const groupCategory = group.getAttribute('data-category');
            if (groupCategory === category) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
                group.querySelectorAll('input, textarea').forEach(field => {
                    field.value = '';
                });
            }
        });
        
        updatePreview();
    }
    
    // ===== Preview Update =====
    function updatePreview() {
        const title = document.getElementById('id_title').value;
        const description = document.getElementById('id_description').value;
        const category = categoryField.value;
        const priority = priorityField.value;
        const amount = document.getElementById('id_amount').value;
        const config = categoryConfigs[category] || categoryConfigs['other'];
        
        if (!title && !description) {
            previewContent.innerHTML = `
                <div class="preview-empty">
                    <i class="bi bi-file-earmark-text d-block"></i>
                    <p class="mb-0" style="font-size: var(--font-sm);">
                        {% trans "Fill in the form to see a preview" %}
                    </p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        if (title) {
            html += `
                <div class="preview-field">
                    <div class="preview-label">{% trans "Title" %}</div>
                    <div class="preview-value">${escapeHtml(title)}</div>
                </div>
            `;
        }
        
        if (description) {
            html += `
                <div class="preview-field">
                    <div class="preview-label">{% trans "Description" %}</div>
                    <div class="preview-value" style="font-weight: 400;">${escapeHtml(description).substring(0, 100)}${description.length > 100 ? '...' : ''}</div>
                </div>
            `;
        }
        
        html += `
            <div class="row g-2">
                <div class="col-6">
                    <div class="preview-field mb-0">
                        <div class="preview-label">{% trans "Category" %}</div>
                        <div class="preview-value">
                            <span class="badge bg-primary-custom">${categoryNames[category] || category}</span>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="preview-field mb-0">
                        <div class="preview-label">{% trans "Priority" %}</div>
                        <div class="preview-value">
                            <span class="badge ${getPriorityClass(priority)}">${priorityNames[priority] || priority}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        if (config.show_amount && amount) {
            html += `
                <div class="preview-field mt-3 pt-3 border-top">
                    <div class="preview-label">{% trans "Amount" %}</div>
                    <div class="preview-amount">$${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                </div>
            `;
        }
        
        if (selectedFiles.length > 0) {
            html += `
                <div class="preview-field mt-3 pt-3 border-top">
                    <div class="preview-label">{% trans "Attachments" %}</div>
                    <div class="preview-value">${selectedFiles.length} {% trans "file(s)" %}</div>
                </div>
            `;
        }
        
        previewContent.innerHTML = html;
    }
    
    function getPriorityClass(priority) {
        const classes = {
            'low': 'bg-success',
            'medium': 'bg-warning text-dark',
            'high': 'bg-danger'
        };
        return classes[priority] || 'bg-secondary';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ===== Toast Helper =====
    function showToast(message, type = 'success') {
        const closeBtn = document.getElementById('toast-close-btn');
        toastMessage.textContent = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white', 'text-dark');
        closeBtn.classList.remove('btn-close-white');
        
        if (type === 'success') {
            toastEl.classList.add('bg-success', 'text-white');
            toastIcon.className = 'bi bi-check-circle me-2';
            closeBtn.classList.add('btn-close-white');
        } else if (type === 'error') {
            toastEl.classList.add('bg-danger', 'text-white');
            toastIcon.className = 'bi bi-exclamation-circle me-2';
            closeBtn.classList.add('btn-close-white');
        } else if (type === 'warning') {
            toastEl.classList.add('bg-warning', 'text-dark');
            toastIcon.className = 'bi bi-exclamation-triangle me-2';
            // Dark close button for better contrast on yellow
        } else {
            toastEl.classList.add('bg-info', 'text-white');
            toastIcon.className = 'bi bi-info-circle me-2';
            closeBtn.classList.add('btn-close-white');
        }
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    
    // ===== WebAuthn Modal State =====
    function showModalState(state) {
        webauthnInitial.style.display = state === 'initial' ? 'block' : 'none';
        webauthnProcessing.style.display = state === 'processing' ? 'block' : 'none';
        webauthnSuccess.style.display = state === 'success' ? 'block' : 'none';
        webauthnError.style.display = state === 'error' ? 'block' : 'none';
        
        webauthnConfirmBtn.style.display = state === 'initial' ? 'inline-block' : 'none';
        webauthnRetryBtn.style.display = state === 'error' ? 'inline-block' : 'none';
        webauthnCancelBtn.style.display = ['initial', 'error'].includes(state) ? 'inline-block' : 'none';
    }
    
    // ===== Base64 Helpers =====
    function base64ToBuffer(base64) {
        const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
        const buffer = new ArrayBuffer(binary.length);
        const view = new Uint8Array(buffer);
        for (let i = 0; i < binary.length; i++) {
            view[i] = binary.charCodeAt(i);
        }
        return buffer;
    }

    function bufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        const chunkSize = 8192;
        for (let i = 0; i < bytes.byteLength; i += chunkSize) {
            const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.byteLength));
            binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    // ===== WebAuthn Authentication =====
    async function performWebAuthn() {
        showModalState('processing');
        
        try {
            const formData = new FormData(form);
            const contextData = {
                title: formData.get('title') || '',
                category: formData.get('category') || '',
                amount: formData.get('amount') || '',
            };
            
            const optionsResponse = await fetch(webauthnOptionsUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(contextData)
            });

            if (!optionsResponse.ok) {
                const errorData = await optionsResponse.json();
                if (errorData.noCredentials) {
                    throw new Error('{% trans "No biometric credentials registered. Please register a device from your profile first." %}');
                }
                throw new Error(errorData.error || '{% trans "Failed to get authentication options" %}');
            }

            const optionsResult = await optionsResponse.json();
            const { options } = optionsResult;
            creationToken = optionsResult.creationToken;

            const publicKey = {
                challenge: base64ToBuffer(options.challenge),
                timeout: options.timeout || 60000,
                rpId: options.rpId,
                allowCredentials: (options.allowCredentials || []).map(cred => ({
                    type: cred.type,
                    id: base64ToBuffer(cred.id),
                    transports: cred.transports || []
                })),
                userVerification: options.userVerification || 'required'
            };

            const assertion = await navigator.credentials.get({ publicKey });

            if (!assertion) {
                throw new Error('{% trans "WebAuthn authentication was cancelled" %}');
            }

            const assertionData = {
                id: assertion.id,
                rawId: bufferToBase64(assertion.rawId),
                response: {
                    clientDataJSON: bufferToBase64(assertion.response.clientDataJSON),
                    authenticatorData: bufferToBase64(assertion.response.authenticatorData),
                    signature: bufferToBase64(assertion.response.signature),
                    userHandle: assertion.response.userHandle ? bufferToBase64(assertion.response.userHandle) : null,
                },
                type: assertion.type
            };

            const verifyResponse = await fetch(webauthnVerifyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    creationToken: creationToken,
                    response: assertionData
                })
            });

            if (!verifyResponse.ok) {
                const errorData = await verifyResponse.json();
                throw new Error(errorData.error || '{% trans "Authentication verification failed" %}');
            }

            const verifyResult = await verifyResponse.json();

            if (!verifyResult.success) {
                throw new Error(verifyResult.error || '{% trans "Verification failed" %}');
            }

            showModalState('success');
            verifiedTokenField.value = verifyResult.verifiedToken;
            
            setTimeout(() => {
                webauthnModal.hide();
                HTMLFormElement.prototype.submit.call(form);
            }, 800);

        } catch (error) {
            console.error('WebAuthn error:', error);
            
            let errorMsg = error.message;
            if (error.name === 'NotAllowedError') {
                errorMsg = '{% trans "Biometric authentication was cancelled or denied. Please try again." %}';
            } else if (error.name === 'InvalidStateError') {
                errorMsg = '{% trans "No matching credential found on this device." %}';
            } else if (error.name === 'NotSupportedError') {
                errorMsg = '{% trans "This device does not support the required authentication method." %}';
            }
            
            webauthnErrorMessage.textContent = errorMsg;
            showModalState('error');
        }
    }
    
    // ===== Event Handlers =====
    webauthnConfirmBtn.addEventListener('click', performWebAuthn);
    webauthnRetryBtn.addEventListener('click', () => showModalState('initial'));
    
    document.getElementById('webauthnModal').addEventListener('hidden.bs.modal', function() {
        showModalState('initial');
        creationToken = null;
    });
    
    // Form input listeners
    document.getElementById('id_title').addEventListener('input', () => {
        updatePreview();
        if (document.getElementById('id_title').value) {
            updateStepIndicator(2);
        }
    });
    document.getElementById('id_description').addEventListener('input', updatePreview);
    document.getElementById('id_amount').addEventListener('input', updatePreview);
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const category = categoryField.value;
        const config = categoryConfigs[category] || categoryConfigs['other'];
        
        let hasErrors = false;
        const errorFields = [];
        
        // Validate required fields
        config.required_fields.forEach(fieldName => {
            const field = document.getElementById('id_' + fieldName);
            if (field && !field.value.trim()) {
                field.classList.add('field-error');
                errorFields.push(fieldName);
                hasErrors = true;
            } else if (field) {
                field.classList.remove('field-error');
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
            showToast('{% trans "Please fill in all required fields." %}', 'warning');
            // Scroll to first error
            const firstError = document.querySelector('.field-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
            return;
        }
        
        // Update files before submit
        updateFileInput();
        
        // If we have a verified token, allow submit
        if (verifiedTokenField.value) {
            return;
        }
        
        // Otherwise, show WebAuthn modal
        e.preventDefault();
        
        if (!navigator.credentials || !navigator.credentials.get) {
            showToast('{% trans "WebAuthn is not supported on this device/browser." %}', 'error');
            return;
        }
        
        webauthnModal.show();
    });
    
    // Initialize
    updateFormFields();
    updateStepIndicator(1);
});
</script>
{% endblock %}