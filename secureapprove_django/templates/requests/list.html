{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Requests" %} - SecureApprove{% endblock %}

{% block extra_css %}
<style>
.filter-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

[data-theme="dark"] .filter-card {
    background: #2b3035;
    border: 1px solid #495057;
}

.request-card {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
}

[data-theme="dark"] .request-card {
    background-color: #212529;
    border-color: #495057;
}

.request-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.status-badge {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-indicator {
    width: 4px;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
}

.priority-high { background-color: #dc3545; }
.priority-medium { background-color: #ffc107; }
.priority-low { background-color: #28a745; }

.amount-display {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2c3e50;
}

[data-theme="dark"] .amount-display {
    color: #e9ecef;
}

.metadata-pill {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
    display: inline-block;
}

[data-theme="dark"] .metadata-pill {
    background: #343a40;
    color: #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">{% trans "Approval Requests" %}</h1>
            <p class="text-muted mb-0">
                {% blocktrans count total=page_obj.paginator.count %}
                    {{ total }} request
                {% plural %}
                    {{ total }} requests
                {% endblocktrans %}
            </p>
        </div>
        <a href="{% url 'requests:create' %}" class="btn btn-primary" title="{% trans 'New Request' %}">
            <i class="bi bi-plus-lg"></i>
        </a>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">{% trans "Status" %}</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="all" {% if not status_filter or status_filter == 'all' %}selected{% endif %}>{% trans "All Statuses" %}</option>
                    {% for value, label in statuses %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">{% trans "Category" %}</label>
                <select name="category" class="form-select" onchange="this.form.submit()">
                    <option value="all" {% if not category_filter or category_filter == 'all' %}selected{% endif %}>{% trans "All Categories" %}</option>
                    {% for value, label in categories %}
                        <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">{% trans "Search" %}</label>
                <input type="text" name="q" id="searchInput" class="form-control" placeholder="{% trans 'Search by title or description...' %}" value="{{ search_query|default:'' }}">
            </div>
            
            <div class="col-md-2">
                <div class="d-flex gap-2 justify-content-end">
                    {% if status_filter != 'all' or category_filter != 'all' or search_query %}
                        <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary" title="{% trans 'Clear Filters' %}">
                            <i class="bi bi-x-lg"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <!-- Requests List -->
    {% if page_obj.object_list %}
        <div class="row" id="requestsContainer">
            {% for request_obj in page_obj.object_list %}
                <div class="col-lg-6 col-xl-4 mb-4 request-item" data-title="{{ request_obj.title|lower }}" data-description="{{ request_obj.description|lower }}">
                    <div class="card request-card h-100 position-relative" data-request-id="{{ request_obj.pk }}">
                        <!-- Priority Indicator -->
                        <div class="priority-indicator priority-{{ request_obj.priority }}"></div>
                        
                        <div class="card-body d-flex flex-column">
                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0 flex-grow-1 me-2">
                                    <a href="{% url 'requests:detail' request_obj.pk %}" class="text-decoration-none">
                                        {{ request_obj.title }}
                                    </a>
                                </h6>
                                <span class="status-badge badge bg-{% if request_obj.status == 'approved' %}success{% elif request_obj.status == 'rejected' %}danger{% else %}warning{% endif %}">
                                    {{ request_obj.get_status_display }}
                                </span>
                            </div>
                            
                            <!-- Description -->
                            <p class="card-text text-muted small mb-3">
                                {{ request_obj.description|truncatewords:15 }}
                            </p>
                            
                            <!-- Category and Amount -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge bg-primary">{{ request_obj.get_category_display }}</span>
                                {% if request_obj.amount %}
                                    <span class="amount-display">${{ request_obj.amount|floatformat:2 }}</span>
                                {% endif %}
                            </div>
                            
                            <!-- Metadata -->
                            {% if request_obj.metadata %}
                                <div class="mb-3">
                                    {% for key, value in request_obj.metadata.items %}
                                        {% if value %}
                                            <span class="metadata-pill">
                                                {{ key|title }}: {{ value|truncatechars:20 }}
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Footer -->
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center text-muted small">
                                    <span>
                                        <i class="bi bi-person"></i>
                                        {{ request_obj.requester.first_name }} {{ request_obj.requester.last_name }}
                                    </span>
                                    <span>
                                        <i class="bi bi-calendar"></i>
                                        <span class="local-date" data-iso="{{ request_obj.created_at|date:'c' }}">{{ request_obj.created_at|date:"M d, Y" }}</span>
                                    </span>
                                </div>
                                
                                {% if request_obj.approved_by %}
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-check-circle"></i>
                                        {% trans "Approved by" %} {{ request_obj.approved_by.first_name }} {{ request_obj.approved_by.last_name }}
                                    </div>
                                {% elif request_obj.status == 'rejected' %}
                                    <div class="text-danger small mt-1">
                                        <i class="bi bi-x-circle"></i>
                                        {% trans "Rejected" %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Stretched link for whole card clickability -->
                        <a href="{% url 'requests:detail' request_obj.pk %}" class="stretched-link"></a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
            <nav aria-label="{% trans 'Requests pagination' %}">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}{% if search_query %}q={{ search_query }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                <i class="bi bi-chevron-left"></i>
                                {% trans "Previous" %}
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}{% if search_query %}q={{ search_query }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}{% if search_query %}q={{ search_query }}&{% endif %}page={{ page_obj.next_page_number }}">
                                {% trans "Next" %}
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    {% else %}
        <!-- Empty State -->
        <div id="empty-state" class="text-center py-5">
            <div class="mb-4">
                <i class="bi bi-inbox display-1 text-muted"></i>
            </div>
            <h4 class="text-muted">{% trans "No requests found" %}</h4>
            <p class="text-muted mb-4">
                {% if search_query or status_filter != 'all' or category_filter != 'all' %}
                    {% trans "Try adjusting your filters or search terms." %}
                {% else %}
                    {% trans "Start by creating your first approval request." %}
                {% endif %}
            </p>
            {% if not search_query and status_filter == 'all' and category_filter == 'all' %}
                <a href="{% url 'requests:create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i>
                    {% trans "Create First Request" %}
                </a>
            {% else %}
                <a href="{% url 'requests:list' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise"></i>
                    {% trans "Clear Filters" %}
                </a>
            {% endif %}
        </div>
        <div class="row" id="requests-container" style="display: none;"></div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getStatusColor(status) {
        switch(status) {
            case 'approved': return 'success';
            case 'rejected': return 'danger';
            default: return 'warning';
        }
    }

    // Real-time Updates
    window.addEventListener('approval-request-received', function(event) {
        const notificationData = event.detail;
        console.log('New request notification received:', notificationData);
        
        // Fetch full details to render the card correctly
        fetch(`/dashboard/api/requests/${notificationData.request_id}/`)
            .then(response => response.json())
            .then(data => {
                const container = document.querySelector('.row') || document.getElementById('requests-container');
                const emptyState = document.getElementById('empty-state');
                
                if (emptyState) {
                    emptyState.style.display = 'none';
                    if (container.id === 'requests-container') {
                        container.style.display = 'flex';
                        container.className = 'row';
                    }
                }

                // Create new card HTML
                const detailUrl = "{% url 'requests:detail' 0 %}".replace('0', data.id);
                const col = document.createElement('div');
                col.className = 'col-lg-6 col-xl-4 mb-4 new-request-item';
                col.innerHTML = `
                    <div class="card request-card h-100 position-relative border-primary" data-request-id="${data.id}">
                        <div class="priority-indicator priority-${data.priority || 'medium'}"></div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0 flex-grow-1 me-2">
                                    <a href="#" class="text-decoration-none">${data.title}</a>
                                </h6>
                                <span class="status-badge badge bg-warning">Pending</span>
                            </div>
                            <p class="card-text text-muted small mb-3">${data.description ? (data.description.length > 100 ? data.description.substring(0, 100) + '...' : data.description) : ''}</p>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge bg-primary">${data.category_display || data.category || 'Request'}</span>
                                ${data.amount ? `<span class="amount-display">$${parseFloat(data.amount).toFixed(2)}</span>` : ''}
                            </div>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center text-muted small">
                                    <span><i class="bi bi-person"></i> ${data.requester.first_name} ${data.requester.last_name}</span>
                                    <span><i class="bi bi-calendar"></i> ${new Date(data.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <a href="${detailUrl}" class="stretched-link"></a>
                    </div>
                `;

                // Prepend to list
                container.insertBefore(col, container.firstChild);
                
                // Highlight animation
                setTimeout(() => col.classList.add('show'), 100);
            })
            .catch(error => console.error('Error fetching new request details:', error));
    });

    window.addEventListener('approval-status-received', function(event) {
        const data = event.detail;
        console.log('Status update received:', data);
        
        // Find the card
        const card = document.querySelector(`.card[data-request-id="${data.request_id}"]`);
        if (card) {
            // 1. Update Status Badge
            const badge = card.querySelector('.status-badge');
                if (badge) {
                    badge.className = `status-badge badge bg-${getStatusColor(data.status)}`;
                    // Capitalize first letter
                    badge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                }
                
                // 2. Update Footer
                const footerDiv = card.querySelector('.mt-auto');
                if (footerDiv) {
                    // Remove existing status footer if any
                    const existingStatusFooter = footerDiv.querySelector('.text-muted.small.mt-1, .text-danger.small.mt-1');
                    if (existingStatusFooter) {
                        existingStatusFooter.remove();
                    }

                    const newFooter = document.createElement('div');
                    newFooter.className = 'small mt-1';
                    
                    if (data.status === 'approved') {
                        newFooter.className += ' text-muted';
                        const approverText = data.approver_name ? ` by ${data.approver_name}` : '';
                        newFooter.innerHTML = `<i class="bi bi-check-circle"></i> Approved${approverText}`;
                    } else if (data.status === 'rejected') {
                        newFooter.className += ' text-danger';
                        newFooter.innerHTML = `<i class="bi bi-x-circle"></i> Rejected`;
                    }
                    
                    footerDiv.appendChild(newFooter);
                }

                // 3. Visual Highlight
                card.style.transition = 'background-color 0.5s ease';
                const originalBg = card.style.backgroundColor;
                card.style.backgroundColor = '#fff3cd'; // Light yellow highlight
                setTimeout(() => {
                    card.style.backgroundColor = originalBg;
                }, 2000);
            }
    });

    // Format dates to local time
    document.querySelectorAll('.local-date').forEach(function(element) {
        const isoDate = element.getAttribute('data-iso');
        if (isoDate) {
            const date = new Date(isoDate);
            if (!isNaN(date.getTime())) {
                element.textContent = date.toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }
    });

    // Dynamic search - client-side filtering with pagination update
    const searchInput = document.getElementById('searchInput');
    const requestItems = document.querySelectorAll('.request-item');
    const paginationNav = document.querySelector('nav[aria-label]');
    const requestCountText = document.querySelector('.text-muted.mb-0');
    let searchTimeout = null;
    
    if (searchInput && requestItems.length > 0) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            requestItems.forEach(item => {
                const title = item.dataset.title || '';
                const description = item.dataset.description || '';
                
                if (searchTerm === '' || title.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Count visible items
            const visibleItems = document.querySelectorAll('.request-item:not([style*="display: none"])');
            const visibleCount = visibleItems.length;
            
            // Hide/show pagination based on search
            if (paginationNav) {
                if (searchTerm !== '') {
                    paginationNav.style.display = 'none';
                } else {
                    paginationNav.style.display = '';
                }
            }
            
            // Update count text dynamically
            if (requestCountText && searchTerm !== '') {
                const singularText = '{% trans "request" %}';
                const pluralText = '{% trans "requests" %}';
                requestCountText.textContent = visibleCount + ' ' + (visibleCount === 1 ? singularText : pluralText);
            }
            
            // Show/hide no results message
            let noResultsMsg = document.getElementById('noSearchResults');
            
            if (visibleCount === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noSearchResults';
                    noResultsMsg.className = 'col-12 text-center py-5 text-muted';
                    noResultsMsg.innerHTML = '<i class="bi bi-search display-4 mb-3 d-block opacity-50"></i>{% trans "No requests match your search." %}';
                    document.getElementById('requestsContainer').appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = '';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
            
            // Debounced server-side search for more accurate results
            clearTimeout(searchTimeout);
            if (searchTerm.length >= 3) {
                searchTimeout = setTimeout(function() {
                    // Submit form to server for full search across all pages
                    searchInput.form.submit();
                }, 800);
            }
        });
        
        // Clear timeout if user presses Enter manually
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
            }
        });
    }

    // iOS Safari visibility handling - refresh page when returning from background
    let lastVisibilityChange = Date.now();
    
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            const timeSinceHidden = Date.now() - lastVisibilityChange;
            console.log('[Requests] Page visible after ' + timeSinceHidden + 'ms');
            
            // If page was hidden for more than 30 seconds, refresh to get latest data
            if (timeSinceHidden > 30000) {
                console.log('[Requests] Refreshing page due to long background time');
                window.location.reload();
            }
        } else {
            lastVisibilityChange = Date.now();
        }
    });

    // Handle pageshow for iOS bfcache
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            console.log('[Requests] Page restored from bfcache - refreshing');
            window.location.reload();
        }
    });

    // Listen for app visibility restored event from chat widget
    window.addEventListener('app-visibility-restored', function() {
        console.log('[Requests] App visibility restored event received');
        // The chat widget already reconnected WebSocket, we just need to wait for updates
    });
</script>
{% endblock %}